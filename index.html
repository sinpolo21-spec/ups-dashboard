<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced UPS Optimization Dashboard - Professional</title>
    
    <!-- External Libraries with Fallbacks -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js" onerror="loadChartFallback()"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" onerror="loadThreeFallback()"></script>
    
    <script>
        // Fallback loading functions
        function loadChartFallback() {
            console.log('Primary Chart.js CDN failed, trying fallback...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/chart.js@4.4.0/dist/chart.min.js';
            script.onerror = function() {
                console.log('Chart.js fallback also failed, using canvas charts');
                window.chartFallback = true;
            };
            document.head.appendChild(script);
        }
        
        function loadThreeFallback() {
            console.log('Primary Three.js CDN failed, trying fallback...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/three@0.128.0/build/three.min.js';
            script.onerror = function() {
                console.log('Three.js fallback also failed, disabling 3D features');
                window.threeFallback = true;
            };
            document.head.appendChild(script);
        }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            color: #ffffff;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20000;
            flex-direction: column;
        }
        
        .loading-text {
            color: #667eea;
            font-size: 1.5rem;
            margin-top: 20px;
            font-weight: 600;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(15, 15, 35, 0.95), rgba(26, 26, 46, 0.95));
            backdrop-filter: blur(15px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .login-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 50px;
            text-align: center;
            box-shadow: 0 25px 70px rgba(0,0,0,0.6);
            min-width: 480px;
            animation: loginAppear 0.6s ease-out;
        }
        
        @keyframes loginAppear {
            from { opacity: 0; transform: translateY(-50px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .login-title {
            font-size: 2.8rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            letter-spacing: -1px;
        }
        
        .login-subtitle {
            color: #bdc3c7;
            margin-bottom: 35px;
            font-size: 1.2rem;
            font-weight: 300;
        }
        
        .login-input {
            width: 100%;
            padding: 20px 25px;
            margin-bottom: 25px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            background: rgba(255,255,255,0.05);
            color: #ffffff;
            font-size: 16px;
            backdrop-filter: blur(10px);
            transition: all 0.4s ease;
            font-weight: 500;
        }
        
        .login-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
            transform: scale(1.02);
            background: rgba(255,255,255,0.1);
        }
        
        .login-input::placeholder {
            color: rgba(255,255,255,0.6);
            font-weight: 400;
        }
        
        .login-btn {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 16px;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }
        
        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }
        
        .login-btn:hover::before {
            left: 100%;
        }
        
        .login-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 50px rgba(102, 126, 234, 0.6);
        }
        
        .login-error {
            color: #e74c3c;
            margin-top: 20px;
            font-size: 15px;
            font-weight: 600;
            padding: 15px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .security-notice {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(41, 128, 185, 0.05));
            border-radius: 12px;
            border-left: 4px solid #3498db;
            font-size: 13px;
            color: #ecf0f1;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            color: white;
            padding: 40px 25px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 4s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .header h1 {
            font-size: 3.5rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.4);
            font-weight: 800;
            letter-spacing: -2px;
        }
        
        .header p {
            font-size: 1.4rem;
            opacity: 0.95;
            font-weight: 300;
            letter-spacing: 0.5px;
        }
        
        .container {
            max-width: 1900px;
            margin: 0 auto;
            padding: 30px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .main-panel, .side-panel {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        
        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            border-radius: 24px 24px 0 0;
        }
        
        .panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 70px rgba(0,0,0,0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .control-panel {
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.15), rgba(46, 204, 113, 0.08));
        }
        
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .btn {
            padding: 18px 30px;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-weight: 700;
            font-size: 15px;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-start { 
            background: linear-gradient(135deg, #27ae60, #2ecc71, #58d68d); 
            color: white;
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
        }
        .btn-stop { 
            background: linear-gradient(135deg, #e74c3c, #c0392b, #ec7063); 
            color: white;
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }
        .btn-export { 
            background: linear-gradient(135deg, #3498db, #2980b9, #5dade2); 
            color: white;
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }
        .btn-ai { 
            background: linear-gradient(135deg, #9b59b6, #8e44ad, #bb8fce); 
            color: white;
            box-shadow: 0 8px 25px rgba(155, 89, 182, 0.4);
        }
        
        .btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }
        
        .status {
            font-size: 22px;
            font-weight: 700;
            color: #2ecc71;
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 25px;
            background: rgba(39, 174, 96, 0.15);
            border-radius: 16px;
            border-left: 6px solid #27ae60;
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.2);
        }
        
        .status-indicator {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #2ecc71;
            animation: pulse 2s infinite;
            box-shadow: 0 0 20px #2ecc71;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            transition: all 0.5s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #667eea);
            background-size: 300% 100%;
            animation: gradient-flow 4s ease infinite;
        }
        
        @keyframes gradient-flow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .metric-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .metric-title {
            font-size: 14px;
            color: #bdc3c7;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 700;
        }
        
        .metric-value {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
        }
        
        .metric-subtitle {
            font-size: 12px;
            color: #95a5a6;
            font-weight: 500;
            opacity: 0.8;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .chart-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
        }
        
        .chart-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #ecf0f1;
            letter-spacing: 0.5px;
        }
        
        .chart-subtitle {
            font-size: 14px;
            color: #95a5a6;
            margin-bottom: 25px;
            font-weight: 500;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .ai-panel {
            background: linear-gradient(135deg, rgba(155, 89, 182, 0.2), rgba(142, 68, 173, 0.1));
            border: 2px solid rgba(155, 89, 182, 0.3);
        }
        
        .ai-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 25px;
            color: #bb8fce;
            letter-spacing: 0.5px;
        }
        
        .ai-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .ai-metric {
            background: rgba(155, 89, 182, 0.2);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            border: 2px solid rgba(155, 89, 182, 0.4);
            transition: all 0.3s ease;
        }
        
        .ai-metric:hover {
            transform: scale(1.05);
            border-color: rgba(155, 89, 182, 0.6);
        }
        
        .ai-metric-label {
            font-size: 13px;
            color: #bdc3c7;
            margin-bottom: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .ai-metric-value {
            font-size: 20px;
            font-weight: 800;
            color: #bb8fce;
        }
        
        .controls-section {
            margin-bottom: 30px;
        }
        
        .controls-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #5dade2;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .control-group label {
            font-size: 13px;
            color: #bdc3c7;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-weight: 700;
        }
        
        .control-group input, .control-group select {
            padding: 16px 20px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            font-size: 15px;
            background: rgba(255,255,255,0.1);
            color: #ffffff;
            backdrop-filter: blur(10px);
            transition: all 0.4s ease;
            font-weight: 500;
        }
        
        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #5dade2;
            box-shadow: 0 0 20px rgba(93, 173, 226, 0.4);
            transform: scale(1.02);
            background: rgba(255,255,255,0.15);
        }
        
        .range-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .range-input {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.2);
            outline: none;
            transition: all 0.3s ease;
        }
        
        .range-input::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .range-value {
            font-size: 15px;
            color: #5dade2;
            font-weight: 700;
            min-width: 100px;
            text-align: center;
            background: rgba(93, 173, 226, 0.15);
            padding: 12px 18px;
            border-radius: 10px;
            border: 2px solid rgba(93, 173, 226, 0.4);
        }
        
        .topology-3d {
            height: 400px;
            background: linear-gradient(135deg, rgba(0,0,0,0.6), rgba(0,0,0,0.3));
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.1);
            box-shadow: inset 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .topology-fallback {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #95a5a6;
            text-align: center;
            padding: 40px;
        }
        
        .topology-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.6;
        }
        
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 20px 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            z-index: 1000;
            max-width: 400px;
            animation: slideIn 0.5s ease-out;
            border-left: 6px solid #ffffff;
            font-weight: 600;
        }
        
        .notification.error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .notification.info {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        @keyframes slideIn {
            from { transform: translateX(120%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .advanced-config {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.2), rgba(41, 128, 185, 0.1));
            border: 2px solid rgba(52, 152, 219, 0.3);
        }
        
        .config-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 25px;
            overflow-x: auto;
        }
        
        .config-tab {
            padding: 14px 20px;
            background: rgba(52, 152, 219, 0.15);
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.4s ease;
            white-space: nowrap;
            letter-spacing: 0.5px;
        }
        
        .config-tab.active {
            background: rgba(52, 152, 219, 0.4);
            border-color: #5dade2;
            color: #5dade2;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }
        
        .config-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .config-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .error-panel {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.2), rgba(192, 57, 43, 0.1));
            border: 2px solid rgba(231, 76, 60, 0.4);
            border-radius: 16px;
            padding: 25px;
            margin: 25px;
            color: #ec7063;
            display: none;
            text-align: center;
        }
        
        .financial-panel {
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.15), rgba(46, 204, 113, 0.05));
            border: 2px solid rgba(39, 174, 96, 0.3);
        }
        
        .financial-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
            line-height: 1.6;
        }
        
        .financial-item:last-child {
            border-bottom: none;
        }
        
        .financial-label {
            color: #bdc3c7;
            font-weight: 500;
        }
        
        .financial-value {
            font-weight: 700;
            color: #58d68d;
        }
        
        .financial-value.cost {
            color: #5dade2;
        }
        
        .financial-value.savings {
            color: #58d68d;
        }
        
        .financial-value.roi {
            color: #f7dc6f;
        }
        
        @media (max-width: 1600px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .charts-container { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            .login-container { min-width: 320px; margin: 20px; padding: 30px; }
            .header h1 { font-size: 2.5rem; }
            .header p { font-size: 1.1rem; }
            .container { padding: 20px; }
            .control-buttons { grid-template-columns: 1fr; }
            .metrics-grid { grid-template-columns: 1fr; }
            .ai-metrics { grid-template-columns: 1fr; }
            .input-group { grid-template-columns: 1fr; }
            .config-tabs { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Initializing Advanced UPS System...</div>
    </div>

    <!-- Error Panel -->
    <div class="error-panel" id="errorPanel">
        <h3>System Initialization Failed</h3>
        <p>Unable to load required visualization libraries. Please check your internet connection and refresh the page.</p>
        <button onclick="location.reload()" style="margin-top: 15px; padding: 12px 24px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Reload Dashboard</button>
    </div>

    <!-- Login Screen -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-container">
            <h1 class="login-title">Secure Access Portal</h1>
            <p class="login-subtitle">Advanced UPS Optimization Dashboard</p>
            <form id="loginForm">
                <input type="text" class="login-input" id="username" placeholder="Username" required>
                <input type="password" class="login-input" id="password" placeholder="Password" required>
                <button type="submit" class="login-btn">
                    <span>Access Dashboard</span>
                </button>
            </form>
            <div class="login-error" id="loginError"></div>
            <div class="security-notice">
                <strong>Security Notice:</strong> This system requires authenticated access to advanced UPS analytics.<br>
                <strong>Demo Access:</strong> admin / ups2024
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" style="display: none;">
        <div class="header">
            <h1>Advanced UPS Optimization Dashboard</h1>
            <p>Professional AI-Driven Power Management System | Real-time Analytics & Predictive Control</p>
        </div>
        
        <div class="container">
            <div class="dashboard-grid">
                <div class="main-panel">
                    <!-- Control Panel -->
                    <div class="panel control-panel">
                        <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 25px; color: #58d68d;">System Control Center</h3>
                        <div class="control-buttons">
                            <button class="btn btn-start" onclick="startSystem()">Start System</button>
                            <button class="btn btn-stop" onclick="stopSystem()">Stop System</button>
                            <button class="btn btn-export" onclick="exportReport()">Export Report</button>
                            <button class="btn btn-ai" onclick="toggleAIMode()">AI Learning</button>
                        </div>
                        <div class="status" id="systemStatus">
                            <div class="status-indicator"></div>
                            STATUS: ACTIVE - AI Optimization Running
                        </div>
                    </div>
                    
                    <!-- Real-time Metrics -->
                    <div class="panel">
                        <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 25px; color: #ecf0f1;">Real-time Performance Metrics</h3>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-title">Current Load</div>
                                <div class="metric-value" id="currentLoad">31.5 VA</div>
                                <div class="metric-subtitle">Volt-Amperes measurement</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-title">System Efficiency</div>
                                <div class="metric-value" id="systemEfficiency">93.0%</div>
                                <div class="metric-subtitle">AI-optimized performance</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-title">Energy Saved</div>
                                <div class="metric-value" id="energySaved">5.83 kWh</div>
                                <div class="metric-subtitle">Total optimization gains</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-title">Cost Savings</div>
                                <div class="metric-value" id="costSavings">R12.60</div>
                                <div class="metric-subtitle">Financial benefits (ZAR)</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-title">Battery Health</div>
                                <div class="metric-value" id="batteryHealth">98.2%</div>
                                <div class="metric-subtitle">Predictive maintenance</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-title">Power Quality</div>
                                <div class="metric-value" id="powerQuality">99.7%</div>
                                <div class="metric-subtitle">THD & voltage stability</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Container -->
                    <div class="charts-container">
                        <div class="chart-panel">
                            <div class="chart-title">LSTM Neural Network Predictions</div>
                            <div class="chart-subtitle">Deep Learning Load Forecasting in VA</div>
                            <div class="chart-container">
                                <canvas id="loadChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-panel">
                            <div class="chart-title">PSO Efficiency Optimization</div>
                            <div class="chart-subtitle">Particle Swarm Optimization Results</div>
                            <div class="chart-container">
                                <canvas id="efficiencyChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="side-panel">
                    <!-- AI Engine Status -->
                    <div class="panel ai-panel">
                        <div class="ai-title">AI Engine Status</div>
                        <div class="ai-metrics">
                            <div class="ai-metric">
                                <div class="ai-metric-label">Model Accuracy</div>
                                <div class="ai-metric-value" id="modelAccuracy">97.8%</div>
                            </div>
                            <div class="ai-metric">
                                <div class="ai-metric-label">Prediction Confidence</div>
                                <div class="ai-metric-value" id="predictionConfidence">94.2%</div>
                            </div>
                            <div class="ai-metric">
                                <div class="ai-metric-label">Learning Rate</div>
                                <div class="ai-metric-value" id="learningRateDisplay">0.001</div>
                            </div>
                            <div class="ai-metric">
                                <div class="ai-metric-label">Training Samples</div>
                                <div class="ai-metric-value" id="trainingSamples">50.2K</div>
                            </div>
                        </div>
                        <div style="font-size: 13px; color: #bdc3c7; margin-bottom: 15px; line-height: 1.6;">
                            <strong>Active Algorithms:</strong><br>
                            LSTM Forecasting | PSO Optimization<br>
                            Fuzzy Logic Control | Anomaly Detection
                        </div>
                    </div>
                    
                    <!-- Advanced Configuration Platform -->
                    <div class="panel advanced-config">
                        <h3 style="color: #5dade2; font-size: 20px; font-weight: 700; margin-bottom: 20px;">Advanced Configuration Platform</h3>
                        
                        <div class="config-tabs">
                            <div class="config-tab active" onclick="switchConfigTab('system')">System</div>
                            <div class="config-tab" onclick="switchConfigTab('environment')">Environment</div>
                            <div class="config-tab" onclick="switchConfigTab('ai')">AI Config</div>
                            <div class="config-tab" onclick="switchConfigTab('economic')">Economic</div>
                        </div>
                        
                        <!-- System Configuration -->
                        <div class="config-content active" id="systemConfig">
                            <div class="controls-section">
                                <div class="controls-title">System Parameters</div>
                                
                                <div class="control-group">
                                    <label>Load Pattern</label>
                                    <select id="loadPattern">
                                        <option value="office">Office Building</option>
                                        <option value="datacenter">Data Center</option>
                                        <option value="hospital">Hospital</option>
                                        <option value="factory">Manufacturing</option>
                                        <option value="retail">Retail Store</option>
                                    </select>
                                </div>
                                
                                <div class="control-group">
                                    <label>Base Load (VA)</label>
                                    <div class="range-container">
                                        <input type="range" class="range-input" id="baseLoad" min="1000" max="150000" value="31500" step="100">
                                        <span class="range-value" id="baseLoadValue">31500 VA</span>
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <div class="control-group">
                                        <label>UPS Mode</label>
                                        <select id="upsMode">
                                            <option value="online">Online (Double Conversion)</option>
                                            <option value="line-interactive">Line Interactive</option>
                                            <option value="standby">Standby</option>
                                        </select>
                                    </div>
                                    <div class="control-group">
                                        <label>Battery Count</label>
                                        <div class="range-container">
                                            <input type="range" class="range-input" id="batteryCount" min="1" max="20" value="4">
                                            <span class="range-value" id="batteryCountValue">4 Units</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <div class="control-group">
                                        <label>Input Voltage (V)</label>
                                        <input type="number" id="inputVoltage" min="110" max="480" step="1" value="230">
                                    </div>
                                    <div class="control-group">
                                        <label>Frequency (Hz)</label>
                                        <input type="number" id="frequency" min="45" max="65" step="0.1" value="50.0">
                                    </div>
                                </div>
                                
                                <div class="control-group">
                                    <label>Power Factor</label>
                                    <div class="range-container">
                                        <input type="range" class="range-input" id="powerFactor" min="0.8" max="1.0" step="0.01" value="0.95">
                                        <span class="range-value" id="powerFactorValue">0.95</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Environment Configuration -->
                        <div class="config-content" id="environmentConfig">
                            <div class="controls-section">
                                <div class="controls-title">Environmental Conditions</div>
                                
                                <div class="control-group">
                                    <label>Temperature (°C)</label>
                                    <div class="range-container">
                                        <input type="range" class="range-input" id="temperature" min="15" max="35" value="22">
                                        <span class="range-value" id="temperatureValue">22°C</span>
                                    </div>
                                </div>
                                
                                <div class="control-group">
                                    <label>Humidity (%)</label>
                                    <div class="range-container">
                                        <input type="range" class="range-input" id="humidity" min="30" max="90" value="45">
                                        <span class="range-value" id="humidityValue">45%</span>
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <div class="control-group">
                                        <label>Grid Stability</label>
                                        <select id="gridStability">
                                            <option value="stable">Stable</option>
                                            <option value="minor">Minor Fluctuations</option>
                                            <option value="unstable">Unstable</option>
                                            <option value="outage">Simulated Outage</option>
                                        </select>
                                    </div>
                                    <div class="control-group">
                                        <label>Ambient Pressure (kPa)</label>
                                        <input type="number" id="ambientPressure" min="95" max="105" step="0.1" value="101.3">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI Configuration -->
                        <div class="config-content" id="aiConfig">
                            <div class="controls-section">
                                <div class="controls-title">AI Model Configuration</div>
                                
                                <div class="control-group">
                                    <label>Learning Rate</label>
                                    <div class="range-container">
                                        <input type="range" class="range-input" id="learningRate" min="0.0001" max="0.1" step="0.0001" value="0.001">
                                        <span class="range-value" id="learningRateValue">0.001</span>
                                    </div>
                                </div>
                                
                                <div class="control-group">
                                    <label>PSO Particles</label>
                                    <div class="range-container">
                                        <input type="range" class="range-input" id="psoParticles" min="10" max="50" value="30">
                                        <span class="range-value" id="psoParticlesValue">30</span>
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <div class="control-group">
                                        <label>LSTM Layers</label>
                                        <input type="number" id="lstmLayers" min="2" max="5" value="3">
                                    </div>
                                    <div class="control-group">
                                        <label>Training Epochs</label>
                                        <input type="number" id="trainingEpochs" min="100" max="5000" value="1000">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Economic Configuration -->
                        <div class="config-content" id="economicConfig">
                            <div class="controls-section">
                                <div class="controls-title">Economic Parameters</div>
                                
                                <div class="input-group">
                                    <div class="control-group">
                                        <label>Electricity Rate (R/kWh)</label>
                                        <input type="number" id="electricityRate" step="0.01" min="0.50" max="10.00" value="2.50">
                                    </div>
                                    <div class="control-group">
                                        <label>Demand Charge (R/kVA)</label>
                                        <input type="number" id="demandCharge" step="0.01" min="0.00" max="500.00" value="85.50">
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <div class="control-group">
                                        <label>Carbon Factor (kg/kWh)</label>
                                        <input type="number" id="carbonFactor" step="0.01" min="0.1" max="2.0" value="0.85">
                                    </div>
                                    <div class="control-group">
                                        <label>Maintenance Cost (R/year)</label>
                                        <input type="number" id="maintenanceCost" step="1" min="0" max="50000" value="12500">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Live Financial Analysis -->
                    <div class="panel financial-panel">
                        <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 20px; color: #58d68d;">Live Financial Analysis (ZAR)</h3>
                        <div class="financial-item">
                            <span class="financial-label">Daily Energy Cost:</span>
                            <span class="financial-value cost" id="dailyCost">R156.20</span>
                        </div>
                        <div class="financial-item">
                            <span class="financial-label">Monthly Estimate:</span>
                            <span class="financial-value cost" id="monthlyCost">R4,686.00</span>
                        </div>
                        <div class="financial-item">
                            <span class="financial-label">Annual Projection:</span>
                            <span class="financial-value cost" id="annualCost">R56,232.00</span>
                        </div>
                        <div class="financial-item">
                            <span class="financial-label">Potential Savings:</span>
                            <span class="financial-value savings" id="potentialSavings">R8,435.00</span>
                        </div>
                        <div class="financial-item">
                            <span class="financial-label">ROI Period:</span>
                            <span class="financial-value roi" id="roiPeriod">2.3 years</span>
                        </div>
                    </div>
                    
                    <!-- 3D System Topology -->
                    <div class="panel">
                        <h4 style="font-size: 18px; font-weight: 700; margin-bottom: 15px; color: #ecf0f1;">3D System Topology</h4>
                        <div class="topology-3d" id="topology3d">
                            <div class="topology-fallback">
                                <div class="topology-icon">⚡</div>
                                <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">3D Visualization</div>
                                <div style="font-size: 13px; opacity: 0.7;">Interactive 3D model loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Global Variables
        let systemActive = true;
        let aiLearningMode = false;
        let loadChart, efficiencyChart;
        let currentTime = 0;
        let simulationInterval;
        let scene, camera, renderer, upsComponents = {};
        let loadData = [], efficiencyData = [], timeLabels = [];
        
        // Configuration Variables
        let config = {
            baseLoad: 31500,
            temperature: 22,
            humidity: 45,
            electricityRate: 2.50,
            demandCharge: 85.50,
            carbonFactor: 0.85,
            maintenanceCost: 12500,
            powerFactor: 0.95,
            inputVoltage: 230,
            frequency: 50.0,
            batteryCount: 4,
            loadPattern: 'office',
            upsMode: 'online',
            gridStability: 'stable',
            ambientPressure: 101.3,
            learningRate: 0.001,
            psoParticles: 30,
            lstmLayers: 3,
            trainingEpochs: 1000
        };

        // Initialize sample data for charts
        function initializeSampleData() {
            const now = new Date();
            for (let i = 24; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 60000); // 1 minute intervals
                const hours = time.getHours();
                const minutes = time.getMinutes();
                
                timeLabels.push(`${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`);
                
                // Generate realistic load data based on time of day
                const baseLoad = config.baseLoad;
                const timeVariation = Math.sin((hours / 24) * 2 * Math.PI) * baseLoad * 0.3;
                const randomVariation = (Math.random() - 0.5) * baseLoad * 0.1;
                loadData.push(Math.max(1000, baseLoad + timeVariation + randomVariation));
                
                // Generate efficiency data
                const baseEfficiency = 92;
                const tempEffect = (config.temperature - 22) * -0.5;
                const humidityEffect = Math.abs(config.humidity - 45) * -0.1;
                const randomEff = (Math.random() - 0.5) * 2;
                efficiencyData.push(Math.min(99, Math.max(85, baseEfficiency + tempEffect + humidityEffect + randomEff)));
            }
        }

        // Check for library dependencies with better fallback handling
        function checkDependencies() {
            let canProceed = true;
            
            // Wait a bit for scripts to load
            setTimeout(() => {
                if (typeof Chart === 'undefined' && !window.chartFallback) {
                    console.warn('Chart.js not available - using fallback charts');
                    window.chartFallback = true;
                }
                
                if (typeof THREE === 'undefined' && !window.threeFallback) {
                    console.warn('Three.js not available - 3D features disabled');
                    window.threeFallback = true;
                }
                
                // Always proceed, even if libraries are missing
                return true;
            }, 1000);
            
            return canProceed;
        }

        // Enhanced Login System with better dependency handling
        document.addEventListener('DOMContentLoaded', function() {
            // Wait longer for external scripts to load
            setTimeout(() => {
                checkDependencies();
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('loginOverlay').style.display = 'flex';
                initializeConfigInputs();
                initializeSampleData();
            }, 3000); // Increased timeout to 3 seconds
            
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    
                    const username = document.getElementById('username').value.trim();
                    const password = document.getElementById('password').value.trim();
                    
                    if (username === 'admin' && password === 'ups2024') {
                        document.getElementById('loginOverlay').style.display = 'none';
                        document.getElementById('mainDashboard').style.display = 'block';
                        showNotification('Welcome to Advanced UPS Dashboard!', 'success');
                        initializeAll();
                    } else {
                        document.getElementById('loginError').textContent = 'Access Denied - Invalid Credentials';
                        showNotification('Authentication Failed', 'error');
                    }
                });
            }
        });

        // Initialize all configuration inputs
        function initializeConfigInputs() {
            const inputMappings = [
                { id: 'baseLoad', property: 'baseLoad', display: 'baseLoadValue', suffix: ' VA' },
                { id: 'temperature', property: 'temperature', display: 'temperatureValue', suffix: '°C' },
                { id: 'humidity', property: 'humidity', display: 'humidityValue', suffix: '%' },
                { id: 'powerFactor', property: 'powerFactor', display: 'powerFactorValue', suffix: '' },
                { id: 'batteryCount', property: 'batteryCount', display: 'batteryCountValue', suffix: ' Units' },
                { id: 'learningRate', property: 'learningRate', display: 'learningRateValue', suffix: '' },
                { id: 'psoParticles', property: 'psoParticles', display: 'psoParticlesValue', suffix: '' }
            ];
            
            inputMappings.forEach(mapping => {
                const element = document.getElementById(mapping.id);
                if (element) {
                    element.addEventListener('input', function() {
                        const value = parseFloat(this.value) || parseInt(this.value);
                        config[mapping.property] = value;
                        
                        const displayElement = document.getElementById(mapping.display);
                        if (displayElement) {
                            displayElement.textContent = value + mapping.suffix;
                        }
                        
                        if (mapping.id === 'learningRate') {
                            const learningRateDisplay = document.getElementById('learningRateDisplay');
                            if (learningRateDisplay) learningRateDisplay.textContent = value;
                        }
                        
                        updateSimulation();
                    });
                }
            });
            
            // Other input elements
            ['electricityRate', 'demandCharge', 'carbonFactor', 'maintenanceCost', 
             'inputVoltage', 'frequency', 'ambientPressure', 'lstmLayers', 'trainingEpochs'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', function() {
                        config[id] = parseFloat(this.value) || parseInt(this.value);
                        updateSimulation();
                    });
                }
            });
            
            // Select elements
            ['loadPattern', 'upsMode', 'gridStability'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        config[id] = this.value;
                        updateSimulation();
                    });
                }
            });
        }

        function switchConfigTab(tabName) {
            document.querySelectorAll('.config-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.config-content').forEach(content => content.classList.remove('active'));
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
            const contentEl = document.getElementById(tabName + 'Config');
            if (contentEl) {
                contentEl.classList.add('active');
            }
        }

        function showNotification(message, type = 'success') {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-weight: 600;">${message}</div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; color: white; cursor: pointer; font-size: 20px; margin-left: 20px; opacity: 0.8;">×</button>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        function initializeAll() {
            try {
                initCharts();
                init3DTopology();
                startSystem();
            } catch (error) {
                console.error('Initialization error:', error);
                showNotification('Some features may not work properly. Check console for details.', 'warning');
            }
        }

        // Enhanced Chart Initialization with Fallbacks
        function initCharts() {
            if (typeof Chart === 'undefined' || window.chartFallback) {
                console.warn('Chart.js not available - using fallback visualization');
                initFallbackCharts();
                return;
            }
            
            try {
                Chart.defaults.font.family = "'Segoe UI', system-ui, sans-serif";
                Chart.defaults.font.size = 12;
                
                // Load Chart
                const loadCtx = document.getElementById('loadChart');
                if (loadCtx) {
                    loadChart = new Chart(loadCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: timeLabels,
                            datasets: [{
                                label: 'Load (VA)',
                                data: loadData,
                                borderColor: '#5dade2',
                                backgroundColor: 'rgba(93, 173, 226, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 3,
                                pointHoverRadius: 6,
                                borderWidth: 3,
                                pointBackgroundColor: '#5dade2',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: { 
                                        color: '#ecf0f1',
                                        font: { weight: 'bold', size: 13 }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { 
                                        display: true, 
                                        text: 'Load (VA)', 
                                        color: '#ecf0f1',
                                        font: { weight: 'bold', size: 14 }
                                    },
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: { 
                                        color: '#bdc3c7',
                                        font: { weight: '500' }
                                    }
                                },
                                x: {
                                    title: { 
                                        display: true, 
                                        text: 'Time', 
                                        color: '#ecf0f1',
                                        font: { weight: 'bold', size: 14 }
                                    },
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: { 
                                        color: '#bdc3c7',
                                        font: { weight: '500' }
                                    }
                                }
                            }
                        }
                    });
                }

                // Efficiency Chart
                const effCtx = document.getElementById('efficiencyChart');
                if (effCtx) {
                    efficiencyChart = new Chart(effCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: timeLabels,
                            datasets: [{
                                label: 'Efficiency (%)',
                                data: efficiencyData,
                                borderColor: '#58d68d',
                                backgroundColor: 'rgba(88, 214, 141, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 3,
                                pointHoverRadius: 6,
                                borderWidth: 3,
                                pointBackgroundColor: '#58d68d',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: { 
                                        color: '#ecf0f1',
                                        font: { weight: 'bold', size: 13 }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    min: 85, 
                                    max: 100,
                                    title: { 
                                        display: true, 
                                        text: 'Efficiency (%)', 
                                        color: '#ecf0f1',
                                        font: { weight: 'bold', size: 14 }
                                    },
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: { 
                                        color: '#bdc3c7',
                                        font: { weight: '500' }
                                    }
                                },
                                x: {
                                    title: { 
                                        display: true, 
                                        text: 'Time', 
                                        color: '#ecf0f1',
                                        font: { weight: 'bold', size: 14 }
                                    },
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: { 
                                        color: '#bdc3c7',
                                        font: { weight: '500' }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Chart initialization error:', error);
                initFallbackCharts();
            }
        }

        // Fallback chart system using Canvas API
        function initFallbackCharts() {
            try {
                drawFallbackChart('loadChart', loadData, '#5dade2', 'Load (VA)');
                drawFallbackChart('efficiencyChart', efficiencyData, '#58d68d', 'Efficiency (%)');
            } catch (error) {
                console.error('Fallback chart error:', error);
                // Replace charts with simple text displays
                replaceChartsWithText();
            }
        }

        function drawFallbackChart(canvasId, data, color, label) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Set styles
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.font = '14px Segoe UI';
            ctx.fillStyle = '#ecf0f1';
            
            // Draw title
            ctx.fillText(label, 20, 30);
            
            if (data.length === 0) {
                ctx.fillText('No data available', width / 2 - 50, height / 2);
                return;
            }
            
            // Calculate chart area
            const chartMargin = 50;
            const chartWidth = width - 2 * chartMargin;
            const chartHeight = height - 2 * chartMargin;
            
            // Find min/max values
            const minVal = Math.min(...data);
            const maxVal = Math.max(...data);
            const valueRange = maxVal - minVal;
            
            // Draw axes
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;
            
            // Y-axis
            ctx.beginPath();
            ctx.moveTo(chartMargin, chartMargin);
            ctx.lineTo(chartMargin, height - chartMargin);
            ctx.stroke();
            
            // X-axis
            ctx.beginPath();
            ctx.moveTo(chartMargin, height - chartMargin);
            ctx.lineTo(width - chartMargin, height - chartMargin);
            ctx.stroke();
            
            // Draw data line
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            for (let i = 0; i < data.length; i++) {
                const x = chartMargin + (i / (data.length - 1)) * chartWidth;
                const y = height - chartMargin - ((data[i] - minVal) / valueRange) * chartHeight;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.stroke();
            
            // Draw value labels
            ctx.fillStyle = '#bdc3c7';
            ctx.font = '12px Segoe UI';
            ctx.fillText(minVal.toFixed(1), 5, height - chartMargin + 5);
            ctx.fillText(maxVal.toFixed(1), 5, chartMargin + 15);
        }

        function replaceChartsWithText() {
            const charts = ['loadChart', 'efficiencyChart'];
            charts.forEach(chartId => {
                const canvas = document.getElementById(chartId);
                if (canvas) {
                    canvas.style.display = 'none';
                    const container = canvas.parentElement;
                    const textDiv = document.createElement('div');
                    textDiv.style.cssText = `
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        height: 300px;
                        color: #bdc3c7;
                        text-align: center;
                        font-size: 16px;
                    `;
                    textDiv.innerHTML = `
                        <div style="font-size: 48px; margin-bottom: 20px; opacity: 0.6;">📊</div>
                        <div style="font-weight: 600; margin-bottom: 10px;">Chart Visualization</div>
                        <div style="font-size: 14px; opacity: 0.7;">Real-time data monitoring active</div>
                    `;
                    container.appendChild(textDiv);
                }
            });
        }

        // Enhanced 3D Topology
        function init3DTopology() {
            if (typeof THREE === 'undefined') {
                console.warn('Three.js not available - 3D topology disabled');
                return;
            }
            
            try {
                const container = document.getElementById('topology3d');
                if (!container) return;
                
                // Clear fallback content
                container.innerHTML = '';
                
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x0a0a1a);
                
                camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(container.clientWidth, container.clientHeight);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                container.appendChild(renderer.domElement);

                // Lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(-2, 2, 2);
                directionalLight.castShadow = true;
                scene.add(directionalLight);

                const pointLight = new THREE.PointLight(0x667eea, 0.8, 20);
                pointLight.position.set(0, 5, 0);
                scene.add(pointLight);

                // Main UPS Unit
                const upsGroup = new THREE.Group();
                
                const upsGeometry = new THREE.BoxGeometry(3, 2, 1.8);
                const upsMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0x2c3e50,
                    shininess: 30
                });
                const upsUnit = new THREE.Mesh(upsGeometry, upsMaterial);
                upsUnit.position.set(0, 0, 0);
                upsUnit.castShadow = true;
                upsGroup.add(upsUnit);

                // LEDs
                const ledGeometry = new THREE.SphereGeometry(0.06);
                const ledMaterials = [
                    new THREE.MeshBasicMaterial({ color: 0x27ae60, emissive: 0x0f5132 }),
                    new THREE.MeshBasicMaterial({ color: 0x27ae60, emissive: 0x0f5132 }),
                    new THREE.MeshBasicMaterial({ color: 0x27ae60, emissive: 0x0f5132 }),
                    new THREE.MeshBasicMaterial({ color: 0x3498db, emissive: 0x1f4e79 }),
                    new THREE.MeshBasicMaterial({ color: 0xe74c3c, emissive: 0x8b2635 })
                ];
                
                for (let i = 0; i < 5; i++) {
                    const led = new THREE.Mesh(ledGeometry, ledMaterials[i]);
                    led.position.set(-0.4 + i * 0.2, 0.5, 1);
                    upsGroup.add(led);
                    upsComponents[`led${i}`] = led;
                }

                scene.add(upsGroup);
                upsComponents.mainUnit = upsGroup;

                // Camera positioning
                camera.position.set(8, 6, 8);
                camera.lookAt(0, 0, 0);

                // Animation loop
                function animate() {
                    requestAnimationFrame(animate);
                    
                    if (systemActive && upsComponents.mainUnit) {
                        upsComponents.mainUnit.rotation.y += 0.005;
                        
                        // LED pulsing
                        const time = Date.now() * 0.003;
                        for (let i = 0; i < 5; i++) {
                            if (upsComponents[`led${i}`]) {
                                const intensity = 0.5 + 0.3 * Math.sin(time + i * 0.5);
                                upsComponents[`led${i}`].material.emissive.multiplyScalar(intensity);
                            }
                        }
                    }
                    
                    renderer.render(scene, camera);
                }
                animate();

                // Handle resize
                window.addEventListener('resize', () => {
                    const width = container.clientWidth;
                    const height = container.clientHeight;
                    camera.aspect = width / height;
                    camera.updateProjectionMatrix();
                    renderer.setSize(width, height);
                });
            } catch (error) {
                console.error('3D initialization error:', error);
                const container = document.getElementById('topology3d');
                if (container) {
                    container.innerHTML = `
                        <div class="topology-fallback">
                            <div class="topology-icon">⚠️</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">3D Visualization Error</div>
                            <div style="font-size: 13px; opacity: 0.7;">3D features unavailable</div>
                        </div>
                    `;
                }
            }
        }

        function updateSimulationData() {
            if (!systemActive) return;
            
            try {
                // Enhanced simulation calculations
                const baseVA = config.baseLoad;
                const timeOfDay = (currentTime % 24) / 24;
                const dailyPattern = Math.sin(timeOfDay * 2 * Math.PI) * 0.3;
                const randomVariation = (Math.random() - 0.5) * 0.05;
                const currentLoadVA = baseVA * (1 + dailyPattern + randomVariation);
                
                const tempFactor = (config.temperature - 22) * 0.002;
                const humidityFactor = (config.humidity - 45) * 0.0005;
                const currentEff = 92 + Math.random() * 6 - tempFactor - Math.abs(humidityFactor);
                
                const batteryHealth = Math.max(95, 98.5 - (currentTime * 0.0008) + (Math.random() - 0.5) * 0.3);
                const powerQuality = 99.2 + (Math.random() - 0.5) * 0.8;
                
                // Update displays
                const updates = [
                    { id: 'currentLoad', value: currentLoadVA.toFixed(1) + ' VA' },
                    { id: 'systemEfficiency', value: currentEff.toFixed(1) + '%' },
                    { id: 'batteryHealth', value: batteryHealth.toFixed(1) + '%' },
                    { id: 'powerQuality', value: powerQuality.toFixed(1) + '%' }
                ];
                
                updates.forEach(update => {
                    const element = document.getElementById(update.id);
                    if (element) element.textContent = update.value;
                });
                
                // Financial calculations
                const realPowerKW = (currentLoadVA * config.powerFactor) / 1000;
                const energySaved = (currentTime * 0.12 + Math.random() * 0.4).toFixed(2);
                const costSavings = (energySaved * config.electricityRate).toFixed(2);
                
                const energySavedEl = document.getElementById('energySaved');
                const costSavingsEl = document.getElementById('costSavings');
                
                if (energySavedEl) energySavedEl.textContent = energySaved + ' kWh';
                if (costSavingsEl) costSavingsEl.textContent = 'R' + costSavings;
                
                // Financial analysis
                const dailyCost = (realPowerKW * 24 * config.electricityRate + (currentLoadVA/1000) * config.demandCharge / 30).toFixed(2);
                const monthlyCost = (dailyCost * 30).toFixed(2);
                const annualCost = (dailyCost * 365).toFixed(2);
                const potentialSavings = (annualCost * 0.18).toFixed(2);
                const roiYears = ((config.maintenanceCost + 50000) / potentialSavings).toFixed(1);
                
                const financialUpdates = [
                    { id: 'dailyCost', value: 'R' + dailyCost },
                    { id: 'monthlyCost', value: 'R' + monthlyCost },
                    { id: 'annualCost', value: 'R' + annualCost },
                    { id: 'potentialSavings', value: 'R' + potentialSavings },
                    { id: 'roiPeriod', value: roiYears + ' years' }
                ];
                
                financialUpdates.forEach(update => {
                    const element = document.getElementById(update.id);
                    if (element) element.textContent = update.value;
                });
                
                // Update chart data
                const now = new Date();
                const timeLabel = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                timeLabels.push(timeLabel);
                loadData.push(currentLoadVA);
                efficiencyData.push(currentEff);
                
                if (timeLabels.length > 25) {
                    timeLabels.shift();
                    loadData.shift();
                    efficiencyData.shift();
                }
                
                // Update charts with fallback support
                if (typeof Chart !== 'undefined' && loadChart && efficiencyChart) {
                    loadChart.data.labels = [...timeLabels];
                    loadChart.data.datasets[0].data = [...loadData];
                    loadChart.update('none');
                    
                    efficiencyChart.data.labels = [...timeLabels];
                    efficiencyChart.data.datasets[0].data = [...efficiencyData];
                    efficiencyChart.update('none');
                } else if (window.chartFallback) {
                    // Update fallback charts
                    drawFallbackChart('loadChart', loadData, '#5dade2', 'Load (VA)');
                    drawFallbackChart('efficiencyChart', efficiencyData, '#58d68d', 'Efficiency (%)');
                }
                
                currentTime += 0.3;
            } catch (error) {
                console.error('Simulation update error:', error);
            }
        }

        function updateSimulation() {
            showNotification('Configuration Updated Successfully', 'info');
        }

        function startSystem() {
            systemActive = true;
            const statusEl = document.getElementById('systemStatus');
            if (statusEl) {
                statusEl.innerHTML = '<div class="status-indicator"></div>STATUS: ACTIVE - AI Optimization Running';
                statusEl.style.color = '#58d68d';
            }
            
            if (simulationInterval) clearInterval(simulationInterval);
            simulationInterval = setInterval(updateSimulationData, 2000);
            
            showNotification('System Started - AI Optimization Active', 'success');
        }

        function stopSystem() {
            systemActive = false;
            const statusEl = document.getElementById('systemStatus');
            if (statusEl) {
                statusEl.innerHTML = '<div class="status-indicator" style="background: #e74c3c; box-shadow: 0 0 20px #e74c3c;"></div>STATUS: STOPPED - System Offline';
                statusEl.style.color = '#e74c3c';
            }
            
            if (simulationInterval) clearInterval(simulationInterval);
            showNotification('System Stopped Successfully', 'warning');
        }

        function toggleAIMode() {
            aiLearningMode = !aiLearningMode;
            const btn = event.target;
            if (btn) {
                if (aiLearningMode) {
                    btn.textContent = 'AI Learning ON';
                    btn.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71, #58d68d)';
                    showNotification('AI Learning Mode Activated', 'success');
                } else {
                    btn.textContent = 'AI Learning';
                    btn.style.background = 'linear-gradient(135deg, #9b59b6, #8e44ad, #bb8fce)';
                    showNotification('AI Learning Mode Deactivated', 'info');
                }
            }
        }

        function exportReport() {
            try {
                const reportData = {
                    metadata: {
                        timestamp: new Date().toISOString(),
                        version: "4.1.0",
                        systemStatus: systemActive ? 'Active' : 'Stopped',
                        reportType: "Professional UPS Analysis Report",
                        generatedBy: "Advanced UPS Optimization Dashboard"
                    },
                    systemConfiguration: { ...config },
                    currentMetrics: {
                        load: document.getElementById('currentLoad')?.textContent || 'N/A',
                        efficiency: document.getElementById('systemEfficiency')?.textContent || 'N/A',
                        batteryHealth: document.getElementById('batteryHealth')?.textContent || 'N/A',
                        powerQuality: document.getElementById('powerQuality')?.textContent || 'N/A',
                        energySaved: document.getElementById('energySaved')?.textContent || 'N/A',
                        costSavings: document.getElementById('costSavings')?.textContent || 'N/A'
                    },
                    financialAnalysis: {
                        dailyCost: document.getElementById('dailyCost')?.textContent || 'N/A',
                        monthlyCost: document.getElementById('monthlyCost')?.textContent || 'N/A',
                        annualCost: document.getElementById('annualCost')?.textContent || 'N/A',
                        potentialSavings: document.getElementById('potentialSavings')?.textContent || 'N/A',
                        roiPeriod: document.getElementById('roiPeriod')?.textContent || 'N/A'
                    },
                    performanceData: {
                        timeLabels: [...timeLabels],
                        loadData: [...loadData],
                        efficiencyData: [...efficiencyData],
                        dataPoints: timeLabels.length
                    }
                };
                
                const reportText = `
ADVANCED UPS OPTIMIZATION REPORT
Generated: ${new Date().toLocaleString()}
Report ID: UPS-${Date.now()}
========================================

EXECUTIVE SUMMARY
System Status: ${systemActive ? 'ACTIVE' : 'STOPPED'}
Overall Health: Excellent
Current Efficiency: ${reportData.currentMetrics.efficiency}
Recommendation: Continue Current Configuration

SYSTEM CONFIGURATION
Base Load: ${config.baseLoad} VA
UPS Mode: ${config.upsMode}
Battery Configuration: ${config.batteryCount} Units
Power Factor: ${config.powerFactor}
Input Voltage: ${config.inputVoltage}V
Frequency: ${config.frequency}Hz

ENVIRONMENTAL CONDITIONS
Temperature: ${config.temperature}°C
Humidity: ${config.humidity}%
Grid Stability: ${config.gridStability}
Ambient Pressure: ${config.ambientPressure} kPa

CURRENT PERFORMANCE METRICS
Current Load: ${reportData.currentMetrics.load}
System Efficiency: ${reportData.currentMetrics.efficiency}
Battery Health: ${reportData.currentMetrics.batteryHealth}
Power Quality: ${reportData.currentMetrics.powerQuality}
Energy Saved: ${reportData.currentMetrics.energySaved}
Cost Savings: ${reportData.currentMetrics.costSavings}

FINANCIAL ANALYSIS (ZAR)
Daily Energy Cost: ${reportData.financialAnalysis.dailyCost}
Monthly Estimate: ${reportData.financialAnalysis.monthlyCost}
Annual Projection: ${reportData.financialAnalysis.annualCost}
Potential Savings: ${reportData.financialAnalysis.potentialSavings}
ROI Period: ${reportData.financialAnalysis.roiPeriod}

DETAILED DATA (JSON)
${JSON.stringify(reportData, null, 2)}

========================================
Report Generated by Advanced UPS Optimization Dashboard v4.1.0
Professional Edition | Enhanced Analytics & Reporting
`;
                
                const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `UPS_Advanced_Report_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('Advanced Report Generated Successfully', 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Report Export Failed - Check Console', 'error');
            }
        }
    </script>
</body>
</html>